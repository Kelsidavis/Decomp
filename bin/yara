#!/usr/bin/env bash
set -euo pipefail
REAL_YARA="${YARA_REAL_BIN:-$(command -v yara || true)}"
# Avoid recursion if this wrapper is first on PATH
if [[ -z "$REAL_YARA" || "$(readlink -f "$REAL_YARA")" == "$(readlink -f "$0")" ]]; then
  REAL_YARA="/usr/bin/yara"
fi

# If first non-flag arg is a directory, expand it to index.yar or *.yar
args=()
did_rules=0
for a in "$@"; do
  if [[ $did_rules -eq 0 && ! "$a" =~ ^- ]]; then
    did_rules=1
    if [[ -d "$a" ]]; then
      if [[ -f "$a/index.yar" ]]; then
        args+=( "$a/index.yar" )
      else
        shopt -s nullglob
        files=( "$a"/*.yar "$a"/*/*.yar )
        shopt -u nullglob
        (( ${#files[@]} )) || { echo "ERROR: no .yar files under $a" >&2; exit 2; }
        exec "$REAL_YARA" "${files[@]}" "${@:2}"
      fi
      continue
    fi
  fi
  args+=( "$a" )
done

exec "$REAL_YARA" "${args[@]}"
